<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Family Care - ‡πÅ‡∏≠‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400;1,500&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400;1,500&display=swap');

    :root {
      --font-size: 16px;
      --background: #ffffff;
      --foreground: oklch(0.145 0 0);
      --card: #ffffff;
      --card-foreground: oklch(0.145 0 0);
      --primary: #030213;
      --secondary: #ececf0;
      --muted: #ececf0;
      --muted-foreground: #717182;
      --accent: #e9ebef;
      --accent-foreground: #030213;
      --border: rgba(0,0,0,0.1);
      --radius: 0.625rem;
    }

    body {
      font-family: 'Nunito', 'Sarabun', 'Noto Sans Thai', system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #f0f8ff;
    }

    .elderly-app {
      --text-4xl: clamp(1.75rem, 4vw, 2.25rem);
      --text-3xl: clamp(1.5rem, 3.5vw, 1.875rem);
      --text-2xl: clamp(1.25rem, 3vw, 1.5rem);
      --text-xl: clamp(1.125rem, 2.5vw, 1.25rem);
      --text-base: clamp(1rem, 2.25vw, 1.125rem);
      --wellness-bg: #f0f8ff;
      --wellness-primary: #4a90e2;
      --wellness-secondary: #81c784;
      --wellness-accent: #fff3e0;
      --wellness-success: #66bb6a;
      --wellness-warning: #ffb74d;
      --wellness-danger: #ef5350;
    }

    * { box-sizing: border-box; }
    input, textarea, select { font-size: max(16px, 1rem) !important; border-radius: 8px; }
    button { min-height: 44px; min-width: 44px; touch-action: manipulation; }
    html, body { height: 100%; height: 100vh; height: 100dvh; }
    #app { min-height: 100vh; min-height: 100dvh; }
    .hidden { display: none !important; }
    .animate-in { animation: slideInFromBottom 0.3s ease-out; }
    @keyframes slideInFromBottom { from { transform: translateY(16px); opacity:0 } to { transform: translateY(0); opacity:1 } }
  </style>
</head>
<body>
  <div id="app" class="elderly-app">
    <div class="w-full max-w-md mx-auto bg-white min-h-screen relative">
      <div id="screen-container" class="w-full h-full overflow-y-auto"></div>
    </div>
  </div>

  <!-- For Firebase Phone Auth reCAPTCHA -->
  <div id="recaptcha-container" class="hidden"></div>

  <script type="module">
    // Firebase v11 (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-analytics.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithPhoneNumber,
      RecaptchaVerifier,
      signOut,
      updateProfile
    } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';
    import {
      getDatabase,
      ref,
      set,
      get,
      update,
      onValue,
      push,
      query,
      orderByChild,
      equalTo
    } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js';

    // Config (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤)
    const firebaseConfig = {
      apiKey: "AIzaSyCoGTpjtt1MPnUAl8xhxDVlwiDCMWK98Ts",
      authDomain: "well-ness-676e8.firebaseapp.com",
      databaseURL: "https://well-ness-676e8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "well-ness-676e8",
      storageBucket: "well-ness-676e8.firebasestorage.app",
      messagingSenderId: "1062299336931",
      appId: "1:1062299336931:web:e644c692ff98957b1c05d6",
      measurementId: "G-WEFY2PM6L6"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Helpers
    const normalizePhone = (phone) => {
      if (!phone) return '';
      let p = phone.replace(/\D/g, '');
      if (p.startsWith('66')) return '+' + p;
      if (p.startsWith('0')) return '+66' + p.slice(1);
      if (!p.startsWith('+')) return '+' + p;
      return p;
    };
    const chatId2 = (a, b) => [a, b].sort().join('_');
    const pathUser = (uid) => `users/${uid}`;
    const pathUsersByPhone = (phone) => `usersByPhone/${phone}`;
    const pathExercise = (uid) => `users/${uid}/exerciseRecords`;
    const pathFriends = (uid) => `users/${uid}/friends`;
    const pathSettings = (uid) => `users/${uid}/settings`;
    const pathChats = (chatId) => `chats/${chatId}/messages`;
    const pathFamilyNotify = (elderUid) => `users/${elderUid}/signals/familyRemind`;

    // Global State
    let confirmationResultGlobal = null;
    let exerciseTimer = null;

    let appState = {
      screen: 'login',           // login | verifyOtp | userSelection | home | exercise | exerciseSession | fatigueRating | family | individualChat | groupChat | health | settings | help | healthHistory
      user: null,                // firebase user
      profile: null,             // db profile
      userMode: 'elderly',       // elderly | family (UI mode)
      role: 'elderly',           // same as profile.role
      // links
      linkedElderlyUid: '',
      linkedFamilyUids: [],
      // settings
      notificationSettings: {
        elderlyExerciseReminder: true,
        familyNotifyOnElderlyDone: true
      },
      // exercise
      exerciseRecords: [],
      currentExercise: null,
      currentTime: 0,
      isPlaying: false,
      isCompleted: false,
      showFatigueSelection: false,
      exerciseData: null,
      // health
      healthView: 'main', // main | week | month
      // chat
      friends: [],
      selectedContactId: '',
      chats: {},
      groupChatId: null,
      // notifications
      showNotification: false,
      notificationType: 'exercise', // exercise | elderDone
      showExerciseSuccess: false
    };

    // OTP recaptcha
    const setupRecaptcha = () => {
      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
      }
    };

    // Auth
    onAuthStateChanged(auth, async (user) => {
      appState.user = user || null;
      if (user) {
        await ensureUserProfile(user);
        await hydrateData();
        appState.screen = 'home';
        render();
        startRealtimeListeners();
      } else {
        appState.screen = 'login';
        appState.profile = null;
        appState.exerciseRecords = [];
        appState.friends = [];
        appState.chats = {};
        render();
      }
    });

    async function ensureUserProfile(user) {
      const snap = await get(ref(db, pathUser(user.uid)));
      let profile = snap.exists() ? snap.val() : null;
      if (!profile) {
        const name = user.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà';
        const phone = user.phoneNumber ? normalizePhone(user.phoneNumber) : '';
        profile = { uid: user.uid, name, phone, role: 'elderly', linkedElderlyUid: '', linkedFamilyUids: [], createdAt: Date.now() };
        await set(ref(db, pathUser(user.uid)), profile);
        if (phone) await set(ref(db, pathUsersByPhone(phone)), { uid: user.uid });
      } else {
        if (profile.phone) await set(ref(db, pathUsersByPhone(profile.phone)), { uid: user.uid });
      }
      appState.profile = profile;
      appState.role = profile.role || 'elderly';
      appState.userMode = appState.role;
    }

    async function hydrateData() {
      const uid = auth.currentUser.uid;
      // settings
      const setSnap = await get(ref(db, pathSettings(uid)));
      if (setSnap.exists()) {
        const s = setSnap.val();
        appState.notificationSettings.elderlyExerciseReminder = !!s.elderlyExerciseReminder;
        appState.notificationSettings.familyNotifyOnElderlyDone = !!s.familyNotifyOnElderlyDone;
      } else {
        if (appState.role === 'elderly') await set(ref(db, pathSettings(uid)), { elderlyExerciseReminder: true });
        else await set(ref(db, pathSettings(uid)), { familyNotifyOnElderlyDone: true });
      }
      // exercise
      const ex = await get(ref(db, pathExercise(uid)));
      appState.exerciseRecords = ex.exists() ? Object.values(ex.val()).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)) : [];
      // friends
      const fr = await get(ref(db, pathFriends(uid)));
      appState.friends = fr.exists() ? Object.values(fr.val()) : [];
      // group chat namespace
      appState.groupChatId = `group_${uid}`;
    }

    function startRealtimeListeners() {
      const uid = auth.currentUser.uid;

      // own exercise updates
      onValue(ref(db, pathExercise(uid)), (snap) => {
        if (!snap.exists()) { appState.exerciseRecords = []; return; }
        appState.exerciseRecords = Object.values(snap.val()).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
        renderIfOn(['home','health','healthHistory']);
      });

      // friends updates
      onValue(ref(db, pathFriends(uid)), (snap) => {
        appState.friends = snap.exists() ? Object.values(snap.val()) : [];
        renderIfOn(['family','individualChat','groupChat']);
      });

      // settings
      onValue(ref(db, pathSettings(uid)), (snap) => {
        if (!snap.exists()) return;
        const s = snap.val();
        if (appState.role === 'elderly') appState.notificationSettings.elderlyExerciseReminder = !!s.elderlyExerciseReminder;
        else appState.notificationSettings.familyNotifyOnElderlyDone = !!s.familyNotifyOnElderlyDone;
      });

      // Family -> signal elderly reminder
      if (appState.role === 'elderly') {
        onValue(ref(db, pathFamilyNotify(uid)), (snap) => {
          const v = snap.val();
          if (!v) return;
          if (appState.notificationSettings.elderlyExerciseReminder && v.triggerAt && (Date.now() - v.triggerAt < 60*60*1000)) {
            appState.notificationType = 'exercise';
            appState.showNotification = true;
            render();
          }
        });
      }

      // Family side: show in-app notification when elderly finished
      if (appState.role === 'family' && appState.profile?.linkedElderlyUid) {
        const elderUid = appState.profile.linkedElderlyUid;
        onValue(ref(db, pathExercise(elderUid)), (snap) => {
          if (!snap.exists()) return;
          const list = Object.values(snap.val()).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
          const latest = list[0];
          if (latest && appState.notificationSettings.familyNotifyOnElderlyDone) {
            appState.notificationType = 'elderDone';
            appState.showNotification = true;
            render();
          }
        });
      }
    }

    function renderIfOn(screens) {
      if (screens.includes(appState.screen)) render();
    }

    // OTP flow
    function requestOTP(e) {
      e?.preventDefault?.();
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const phone = normalizePhone(document.getElementById('phone').value.trim());
      const role = document.querySelector('input[name="role"]:checked')?.value || 'elderly';
      if (!firstName || !lastName || !phone) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'); return; }
      setupRecaptcha();
      signInWithPhoneNumber(auth, phone, window.recaptchaVerifier).then((res) => {
        confirmationResultGlobal = res;
        window.__pendingProfile = { firstName, lastName, phone, role };
        appState.screen = 'verifyOtp';
        render();
      }).catch(err => alert('‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + (err?.message || '')));
    }

    async function verifyOTP(e) {
      e?.preventDefault?.();
      const code = document.getElementById('otpCode').value.trim();
      if (!confirmationResultGlobal || !code) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP'); return; }
      try {
        const cred = await confirmationResultGlobal.confirm(code);
        const user = cred.user;
        const p = window.__pendingProfile;
        if (p) {
          const fullName = `${p.firstName} ${p.lastName}`.trim();
          await updateProfile(user, { displayName: fullName });
          const uref = ref(db, pathUser(user.uid));
          const usnap = await get(uref);
          if (!usnap.exists()) {
            const profile = {
              uid: user.uid, name: fullName, phone: normalizePhone(p.phone),
              role: p.role, linkedElderlyUid: '', linkedFamilyUids: [], createdAt: Date.now()
            };
            await set(uref, profile);
            await set(ref(db, pathUsersByPhone(profile.phone)), { uid: user.uid });
            if (p.role === 'elderly') await set(ref(db, pathSettings(user.uid)), { elderlyExerciseReminder: true });
            else await set(ref(db, pathSettings(user.uid)), { familyNotifyOnElderlyDone: true });
          }
        }
        window.__pendingProfile = null;
        confirmationResultGlobal = null;
        appState.screen = 'home';
        render();
      } catch (err) {
        alert('‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + (err?.message || ''));
      }
    }

    async function doLogout() {
      await signOut(auth);
      appState.screen = 'login';
      render();
    }

    // Friends
    async function addFriendByPhone() {
      const phoneRaw = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (‡πÄ‡∏ä‡πà‡∏ô 0812345678)');
      if (!phoneRaw) return;
      const phone = normalizePhone(phoneRaw);
      const mapSnap = await get(ref(db, pathUsersByPhone(phone)));
      if (!mapSnap.exists()) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ'); return; }
      const otherUid = mapSnap.val().uid;
      if (otherUid === auth.currentUser.uid) { alert('‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á'); return; }
      const otherSnap = await get(ref(db, pathUser(otherUid)));
      if (!otherSnap.exists()) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ'); return; }
      const other = otherSnap.val();

      await set(ref(db, `${pathFriends(auth.currentUser.uid)}/${otherUid}`), { uid: otherUid, name: other.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', phone: other.phone || '' });
      await set(ref(db, `${pathFriends(otherUid)}/${auth.currentUser.uid}`), { uid: auth.currentUser.uid, name: appState.profile?.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', phone: appState.profile?.phone || '' });

      // Link roles
      if (appState.role === 'family' && other.role === 'elderly') {
        await update(ref(db, pathUser(auth.currentUser.uid)), { linkedElderlyUid: otherUid });
        appState.profile.linkedElderlyUid = otherUid;
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠/‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
      if (appState.role === 'elderly' && other.role === 'family') {
        const linked = new Set([...(appState.profile?.linkedFamilyUids || []), otherUid]);
        await update(ref(db, pathUser(auth.currentUser.uid)), { linkedFamilyUids: Array.from(linked) });
        appState.profile.linkedFamilyUids = Array.from(linked);
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }

    // Chat
    function openIndividualChat(uid) {
      appState.selectedContactId = uid;
      appState.screen = 'individualChat';
      render();
      subscribeChat(uid);
    }
    function subscribeChat(otherUid) {
      const cid = chatId2(auth.currentUser.uid, otherUid);
      onValue(ref(db, pathChats(cid)), (snap) => {
        appState.chats[cid] = snap.exists() ? Object.values(snap.val()).sort((a,b)=> (a.createdAt||0)-(b.createdAt||0)) : [];
        if (appState.screen === 'individualChat' && appState.selectedContactId === otherUid) render();
      });
    }
    async function sendMessageTo(uid) {
      const input = document.getElementById('messageInput');
      const text = input?.value?.trim();
      if (!text) return;
      const cid = chatId2(auth.currentUser.uid, uid);
      const msgRef = push(ref(db, pathChats(cid)));
      await set(msgRef, { id: msgRef.key, from: auth.currentUser.uid, to: uid, text, createdAt: Date.now() });
      input.value = '';
    }
    function openGroupChat() {
      appState.screen = 'groupChat';
      render();
      const cid = `group_${auth.currentUser.uid}`;
      onValue(ref(db, pathChats(cid)), (snap) => {
        appState.chats[cid] = snap.exists() ? Object.values(snap.val()).sort((a,b)=> (a.createdAt||0)-(b.createdAt||0)) : [];
        if (appState.screen === 'groupChat') render();
      });
    }
    async function sendGroupMessage() {
      const input = document.getElementById('groupMessageInput');
      const text = input?.value?.trim();
      if (!text) return;
      const cid = `group_${auth.currentUser.uid}`;
      const msgRef = push(ref(db, pathChats(cid)));
      await set(msgRef, { id: msgRef.key, from: auth.currentUser.uid, text, createdAt: Date.now() });
      input.value = '';
    }

    // Exercise
    const exercises = [
      { id: 'chair', title: '‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡∏ö‡∏ô‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ', subtitle: '5-10 ‡∏ô‡∏≤‡∏ó‡∏µ', icon: 'ü™ë', difficulty: '‡∏á‡πà‡∏≤‡∏¢', color: '#81c784', duration: 5*60 },
      { id: 'standing', title: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡πà‡∏≤‡∏¢‡∏∑‡∏ô', subtitle: '10-15 ‡∏ô‡∏≤‡∏ó‡∏µ', icon: 'üßç', difficulty: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', color: '#4a90e2', duration: 10*60 },
      { id: 'stretching', title: '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏î‡∏Ñ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô', subtitle: '5-10 ‡∏ô‡∏≤‡∏ó‡∏µ', icon: 'üßò', difficulty: '‡∏á‡πà‡∏≤‡∏¢', color: '#ff9800', duration: 5*60 },
      { id: 'test', title: 'Test 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', subtitle: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', icon: '‚è±Ô∏è', difficulty: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö', color: '#9c27b0', duration: 10 }
    ];

    function startExercise(exId) {
      appState.currentExercise = exId;
      appState.currentTime = 0;
      appState.isPlaying = false;
      appState.isCompleted = false;
      appState.showFatigueSelection = false;
      appState.exerciseData = null;
      appState.screen = 'exerciseSession';
      render();
    }
    function toggleExercise() {
      if (appState.isCompleted) return;
      appState.isPlaying = !appState.isPlaying;
      if (appState.isPlaying) startExerciseTimer();
      else clearInterval(exerciseTimer);
      render();
    }
    function startExerciseTimer() {
      clearInterval(exerciseTimer);
      exerciseTimer = setInterval(() => {
        const ex = exercises.find(e => e.id === appState.currentExercise);
        if (!ex) return;
        if (appState.currentTime + 1 >= ex.duration) {
          appState.isPlaying = false;
          appState.isCompleted = true;
          appState.exerciseData = {
            exerciseType: ex.title,
            duration: Math.max(1, Math.floor(ex.duration / 60)),
            difficulty: ex.difficulty
          };
          appState.showFatigueSelection = true;
          appState.screen = 'fatigueRating';
          clearInterval(exerciseTimer);
          render();
        } else {
          appState.currentTime += 1;
          render();
        }
      }, 1000);
    }
    function stopEarly() {
      const ex = exercises.find(e => e.id === appState.currentExercise);
      if (!ex || appState.currentTime <= 0) return;
      appState.isPlaying = false;
      appState.isCompleted = true;
      appState.exerciseData = {
        exerciseType: ex.title,
        duration: Math.max(1, Math.floor(appState.currentTime / 60)),
        difficulty: ex.difficulty
      };
      appState.showFatigueSelection = true;
      appState.screen = 'fatigueRating';
      clearInterval(exerciseTimer);
      render();
    }
    function resetExercise() {
      clearInterval(exerciseTimer);
      appState.currentTime = 0;
      appState.isPlaying = false;
      appState.isCompleted = false;
      appState.showFatigueSelection = false;
      appState.exerciseData = null;
      appState.currentExercise = null;
      appState.screen = 'exercise';
      render();
    }
    async function selectFatigue(level) {
      if (!appState.exerciseData) return;
      const recordRef = push(ref(db, pathExercise(auth.currentUser.uid)));
      const record = {
        id: recordRef.key,
        date: new Date().toISOString().split('T')[0],
        exerciseType: appState.exerciseData.exerciseType,
        duration: appState.exerciseData.duration,
        completed: true,
        difficulty: appState.exerciseData.difficulty,
        fatigueLevel: level,
        createdAt: Date.now()
      };
      await set(recordRef, record);

      // Reset states
      appState.showExerciseSuccess = true;
      appState.showFatigueSelection = false;
      appState.currentTime = 0;
      appState.isPlaying = false;
      appState.isCompleted = false;
      appState.exerciseData = null;
      appState.currentExercise = null;
      appState.screen = 'home';
      render();
      setTimeout(() => { appState.showExerciseSuccess = false; render(); }, 3000);
    }

    // Notifications
    function showNotificationModal(type) {
      appState.notificationType = type;
      appState.showNotification = true;
      render();
    }
    function closeNotification() {
      appState.showNotification = false;
      render();
    }
    function startNotification() {
      appState.showNotification = false;
      if (appState.userMode === 'elderly' && appState.notificationType === 'exercise') {
        appState.screen = 'exercise';
        render();
      }
    }
    async function sendReminderToElderly() {
      if (appState.role !== 'family' || !appState.profile?.linkedElderlyUid) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      await set(ref(db, pathFamilyNotify(appState.profile.linkedElderlyUid)), {
        triggerAt: Date.now(),
        fromUid: auth.currentUser.uid
      });
      alert('‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠/‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
    }

    // Settings toggles
    async function toggleElderlyExerciseReminder(enabled) {
      await update(ref(db, pathSettings(auth.currentUser.uid)), { elderlyExerciseReminder: !!enabled });
    }
    async function toggleFamilyNotifyOnDone(enabled) {
      await update(ref(db, pathSettings(auth.currentUser.uid)), { familyNotifyOnElderlyDone: !!enabled });
    }

    // Health helpers
    function getWeeklyExerciseCount(records) {
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      return (records || []).filter(r => new Date(r.date) >= oneWeekAgo && r.completed).length;
    }
    function getAverageFatigue(records, limit = 5) {
      const recent = (records || []).filter(r => r.completed && r.fatigueLevel).slice(0, limit);
      if (!recent.length) return null;
      const total = recent.reduce((s, r) => s + (r.fatigueLevel || 0), 0);
      return Math.round((total / recent.length) * 10) / 10;
    }
    function getExerciseRecommendation(fatigue) {
      if (!fatigue) return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏ö‡∏≤‡πÜ';
      if (fatigue <= 2) return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 5-6 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
      if (fatigue <= 3) return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 4-5 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
      if (fatigue <= 4) return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 2-3 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
      return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏ö‡∏≤‡πÜ 1-2 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
    }
    function formatThaiDate(iso) {
      try { return new Date(iso).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'numeric' }); } catch { return iso; }
    }
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // Navigation helpers
    function goto(screen) { appState.screen = screen; render(); }
    function setMode(mode) { appState.userMode = mode; appState.screen = 'home'; render(); }
    function setHealthView(view) {
      appState.healthView = view;
      if (view === 'week') renderAsync(Screens.healthWeek);
      else if (view === 'month') renderAsync(Screens.healthMonth);
      else render();
    }

    // Screens
    const Screens = {
      login: () => `
        <div class="min-h-screen bg-gradient-to-br from-[#f0f8ff] via-[#e8f5e8] to-[#fff3e0] p-6 flex flex-col">
          <div class="text-center pt-10 pb-6">
            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center shadow-lg">üíó</div>
            <h1 class="text-4xl font-bold text-[#333]">Family Care</h1>
            <p class="text-lg text-[#666] mt-1">‡πÅ‡∏≠‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p>
          </div>

          <div class="bg-white rounded-3xl p-6 shadow-lg max-w-md w-full mx-auto">
            <h2 class="text-2xl font-semibold text-[#333] mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</h2>
            <form onsubmit="return false;">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-[#666] mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                  <input id="firstName" type="text" class="w-full px-4 py-3 bg-[#f8f9fa] rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô Tiger" />
                </div>
                <div>
                  <label class="block text-sm text-[#666] mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                  <input id="lastName" type="text" class="w-full px-4 py-3 bg-[#f8f9fa] rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô Phongphaya" />
                </div>
              </div>

              <div class="mt-3">
                <label class="block text-sm text-[#666] mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                <input id="phone" type="tel" inputmode="tel" class="w-full px-4 py-3 bg-[#f8f9fa] rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0929695817" />
                <p class="text-xs text-[#999] mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á OTP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
              </div>

              <div class="mt-4">
                <p class="text-sm text-[#666] mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                <div class="grid grid-cols-2 gap-2">
                  <label class="flex items-center gap-2 p-3 rounded-xl border border-gray-200 cursor-pointer">
                    <input type="radio" name="role" value="elderly" checked />
                    <span class="text-[#333]">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</span>
                  </label>
                  <label class="flex items-center gap-2 p-3 rounded-xl border border-gray-200 cursor-pointer">
                    <input type="radio" name="role" value="family" />
                    <span class="text-[#333]">‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô</span>
                  </label>
                </div>
              </div>

              <button onclick="requestOTP(event)" class="mt-5 w-full bg-[#4a90e2] text-white rounded-2xl py-4 text-lg font-semibold shadow-lg active:scale-95 transition-transform">
                ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP
              </button>
            </form>
          </div>
        </div>
      `,

      verifyOtp: () => `
        <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
          <div class="text-center pt-12 pb-6">
            <h1 class="text-3xl font-bold text-[#333]">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ OTP</h1>
            <p class="text-lg text-[#666] mt-1">‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>

          <div class="bg-white rounded-3xl p-6 shadow-lg max-w-md w-full mx-auto">
            <label class="block text-sm text-[#666] mb-1">‡∏£‡∏´‡∏±‡∏™ OTP</label>
            <input id="otpCode" type="text" inputmode="numeric" class="w-full px-4 py-3 bg-[#f8f9fa] rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none tracking-widest text-center text-2xl" placeholder="------" />
            <button onclick="verifyOTP(event)" class="mt-5 w-full bg-[#81c784] text-white rounded-2xl py-4 text-lg font-semibold shadow-lg active:scale-95 transition-transform">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button onclick="goto('login')" class="mt-2 w-full bg-white text-[#333] border-2 border-[#e0e0e0] rounded-2xl py-3 text-base font-semibold active:scale-95">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          </div>
        </div>
      `,

      userSelection: () => `
        <div class="min-h-screen bg-gradient-to-br from-[#f0f8ff] via-[#e8f5e8] to-[#fff3e0] p-4 sm:p-6 flex flex-col overflow-hidden">
          <div class="text-center mb-8 sm:mb-12 pt-12 sm:pt-20">
            <h1 class="text-5xl sm:text-6xl font-bold text-[#333] mb-3 sm:mb-4 leading-tight tracking-wide">Family Care</h1>
            <p class="text-lg sm:text-2xl text-[#666]">‡πÅ‡∏≠‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p>
          </div>

          <div class="text-center mb-6 sm:mb-8">
            <h2 class="text-2xl sm:text-3xl font-semibold text-[#333] mb-2 leading-tight">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            <p class="text-lg sm:text-xl text-[#666]">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß?</p>
          </div>

          <div class="flex-1 flex flex-col gap-6 sm:gap-8 max-w-sm sm:max-w-md mx-auto w-full">
            <button onclick="setMode('elderly')" class="bg-white rounded-3xl p-6 sm:p-8 shadow-xl border-2 border-[#e0e0e0] hover:border-[#4a90e2] hover:shadow-2xl transition-all duration-300 active:scale-95 min-touch-target">
              <div class="text-center">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">üë¥</div>
                <h3 class="text-2xl sm:text-3xl font-semibold text-[#333] mb-3 leading-tight">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</h3>
                <p class="text-lg sm:text-xl text-[#666] leading-relaxed">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà</p>
              </div>
            </button>

            <button onclick="setMode('family')" class="bg-white rounded-3xl p-6 sm:p-8 shadow-xl border-2 border-[#e0e0e0] hover:border-[#81c784] hover:shadow-2xl transition-all duration-300 active:scale-95 min-touch-target">
              <div class="text-center">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-[#81c784] to-[#ff9800] rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <h3 class="text-2xl sm:text-3xl font-semibold text-[#333] mb-3 leading-tight">‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô</h3>
                <p class="text-lg sm:text-xl text-[#666] leading-relaxed">‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à</p>
              </div>
            </button>
          </div>

          <div class="mt-6 sm:mt-8 text-center px-2"><p class="text-base sm:text-lg text-[#666]">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p></div>
        </div>
      `,

      home: () => {
        const isElderly = appState.userMode === 'elderly';
        if (isElderly) {
          return `
            <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
              <div class="flex items-center justify-between p-4 pt-6">
                <div></div>
                <button onclick="doLogout()" class="text-sm text-[#666] underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
              </div>
              <div class="flex-1 p-6 pb-32">
                <div class="text-center mb-8 pt-2">
                  <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center shadow-lg">üíó</div>
                  <h1 class="text-4xl font-semibold text-[#333] mb-2">Family Care</h1>
                  <p class="text-xl text-[#666]">${appState.profile?.name || ''}</p>
                </div>

                <div class="flex-1 flex flex-col gap-6 max-w-md mx-auto w-full">
                  <button onclick="goto('exercise')" class="bg-white rounded-3xl p-8 shadow-lg border-2 border-[#e0e0e0] hover:border-[#4a90e2] active:scale-95">
                    <div class="flex items-center gap-6">
                      <div class="w-20 h-20 bg-gradient-to-br from-[#81c784] to-[#66bb6a] rounded-full flex items-center justify-center shadow-lg">üèÉ</div>
                      <div class="text-left">
                        <h2 class="text-3xl font-semibold text-[#333]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h2>
                        <p class="text-xl text-[#666] mt-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</p>
                      </div>
                    </div>
                  </button>

                  <button onclick="goto('health')" class="bg-white rounded-3xl p-8 shadow-lg border-2 border-[#e0e0e0] hover:border-[#4a90e2] active:scale-95">
                    <div class="flex items-center gap-6">
                      <div class="w-20 h-20 bg-gradient-to-br from-[#4a90e2] to-[#3f7bd9] rounded-full flex items-center justify-center shadow-lg">ü©∫</div>
                      <div class="text-left">
                        <h2 class="text-3xl font-semibold text-[#333]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
                        <p class="text-xl text-[#666] mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ</p>
                      </div>
                    </div>
                  </button>

                  <button onclick="goto('family')" class="bg-white rounded-3xl p-8 shadow-lg border-2 border-[#e0e0e0] hover:border-[#4a90e2] active:scale-95">
                    <div class="flex items-center gap-6">
                      <div class="w-20 h-20 bg-gradient-to-br from-[#ff9800] to-[#f57c00] rounded-full flex items-center justify-center shadow-lg">üí¨</div>
                      <div class="text-left">
                        <h2 class="text-3xl font-semibold text-[#333]">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</h2>
                        <p class="text-xl text-[#666] mt-1">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô</p>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
              ${renderBottomNavigation('home')}
            </div>
          `;
        } else {
          return `
            <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
              <div class="flex items-center justify-between p-4 pt-6">
                <div></div>
                <button onclick="doLogout()" class="text-sm text-[#666] underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
              </div>
              <div class="flex-1 p-4 pb-32">
                <div class="text-center mb-6 pt-4">
                  <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center shadow-lg">üíó</div>
                  <h1 class="text-2xl font-semibold text-[#333] mb-1">Family Care</h1>
                  <p class="text-lg text-[#666]">${appState.profile?.name || ''}</p>
                </div>

                <div class="space-y-3">
                  <button onclick="sendReminderToElderly()" class="w-full bg-[#4a90e2] text-white rounded-2xl p-4 flex items-center gap-4 shadow-lg active:scale-95">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">üîî</div>
                    <div class="text-left">
                      <h3 class="text-lg font-semibold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠</h3>
                      <p class="text-sm opacity-90">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á)</p>
                    </div>
                  </button>

                  <div class="grid grid-cols-2 gap-3">
                    <button onclick="goto('family')" class="bg-white border-2 border-[#e0e0e0] rounded-2xl p-4 flex flex-col items-center gap-2 shadow-sm active:scale-95">üí¨ <span class="text-sm font-semibold text-[#333]">‡πÅ‡∏ä‡∏ó‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</span></button>
                    <button onclick="goto('health')" class="bg-white border-2 border-[#e0e0e0] rounded-2xl p-4 flex flex-col items-center gap-2 shadow-sm active:scale-95">üìÖ <span class="text-sm font-semibold text-[#333]">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span></button>
                  </div>
                </div>

                <div class="mt-4 bg-[#fff3e0] border border-[#ffb74d] rounded-2xl p-4">
                  <div class="flex items-center gap-3">
                    <div>‚ö†Ô∏è</div>
                    <div>
                      <p class="text-sm font-semibold text-[#333]">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                      <p class="text-sm text-[#666]">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                    </div>
                  </div>
                </div>
              </div>
              ${renderBottomNavigation('home')}
            </div>
          `;
        }
      },

      exercise: () => `
        <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
          <div class="flex items-center gap-4 mb-8 pt-8">
            <button onclick="goto('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
            <h1 class="text-3xl font-semibold text-[#333]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h1>
          </div>

          <div class="flex-1">
            <h2 class="text-2xl font-semibold text-[#333] mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h2>
            <div class="space-y-4">
              ${exercises.map(ex => `
                <button onclick="startExercise('${ex.id}')" class="w-full bg-white rounded-3xl p-6 shadow-lg border-2 border-[#e0e0e0] hover:border-[#4a90e2] active:scale-95">
                  <div class="flex items-center gap-6">
                    <div class="w-20 h-20 rounded-3xl flex items-center justify-center" style="background-color: ${ex.color}20; color: ${ex.color}">
                      <span class="text-4xl">${ex.icon}</span>
                    </div>
                    <div class="text-left flex-1">
                      <h3 class="text-2xl font-semibold text-[#333] mb-1">${ex.title}</h3>
                      <p class="text-lg text-[#666]">${ex.subtitle}</p>
                    </div>
                  </div>
                </button>
              `).join('')}
            </div>

            <div class="mt-8 bg-gradient-to-r from-[#81c784] to-[#4a90e2] rounded-3xl p-6 text-white text-center">
              <div class="text-4xl mb-3">üí™</div>
              <h3 class="text-2xl font-semibold mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h3>
              <p class="text-lg opacity-90">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πá‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          </div>
        </div>
      `,

      exerciseSession: () => {
        const ex = exercises.find(e => e.id === appState.currentExercise);
        const progress = ex ? Math.min(100, (appState.currentTime / ex.duration) * 100) : 0;
        return `
          <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
            <div class="flex items-center gap-4 mb-8 pt-8">
              <button onclick="resetExercise()" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
              <h1 class="text-3xl font-semibold text-[#333]">${ex?.title || ''}</h1>
            </div>

            ${appState.isCompleted && !appState.showFatigueSelection ? `
              <div class="bg-[#81c784] text-white rounded-3xl p-6 mb-6 text-center">
                ‚úÖ
                <h2 class="text-2xl font-semibold mb-2">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h2>
                <p class="text-lg opacity-90">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</p>
              </div>
            ` : ''}

            <div class="bg-black rounded-3xl mb-8 relative overflow-hidden" style="aspect-ratio: 16/9;">
              <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                <div class="text-center">
                  <div class="mb-4 text-white flex justify-center"><span class="text-6xl">${ex?.icon || ''}</span></div>
                  <h3 class="text-2xl text-white mb-2">${ex?.id === 'test' ? '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢'}</h3>
                  <p class="text-lg text-gray-300">${ex?.subtitle || ''}</p>
                  <div class="mt-6">
                    <div class="text-4xl font-bold text-white mb-2">${formatTime(appState.currentTime)} / ${formatTime(ex?.duration || 0)}</div>
                    <div class="w-64 h-3 bg-gray-600 rounded-full mx-auto overflow-hidden">
                      <div class="h-full bg-[#81c784] transition-all duration-1000 ease-out" style="width: ${progress}%"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-6">
                <div class="flex items-center justify-center gap-6">
                  <button onclick="toggleExercise()" ${appState.isCompleted ? 'disabled' : ''} class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg disabled:opacity-50">
                    ${appState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                  </button>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
              <h3 class="text-2xl font-semibold text-[#333] mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h3>
              <div class="space-y-4">
                <div class="flex items-center gap-4">
                  <div class="w-8 h-8 bg-[#81c784] rounded-full flex items-center justify-center">‚è±</div>
                  <div>
                    <p class="text-xl font-semibold text-[#333]">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</p>
                    <p class="text-lg text-[#666]">${ex?.id === 'test' ? `${ex.duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ` : `${Math.floor((ex?.duration||0)/60)} ‡∏ô‡∏≤‡∏ó‡∏µ`}</p>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="w-8 h-8 bg-[#ff9800] rounded-full flex items-center justify-center">üìä</div>
                  <div>
                    <p class="text-xl font-semibold text-[#333]">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</p>
                    <p class="text-lg text-[#666]">${Math.round(progress)}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-auto space-y-4">
              ${!appState.isCompleted ? `
                <button onclick="toggleExercise()" class="w-full bg-[#81c784] text-white rounded-3xl py-6 text-2xl font-semibold shadow-lg active:scale-95 text-center">
                  ${appState.isPlaying ? '‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢'}
                </button>
                ${((ex?.id === 'test' && appState.currentTime > 2) || (ex?.id !== 'test' && appState.currentTime > 60)) ? `
                  <button onclick="stopEarly()" class="w-full bg-[#ff9800] text-white rounded-3xl py-6 text-2xl font-semibold shadow-lg active:scale-95 text-center">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</button>
                ` : ''}
                <button onclick="resetExercise()" class="w-full bg-white text-[#333] border-2 border-[#e0e0e0] rounded-3xl py-6 text-2xl font-semibold shadow-lg active:scale-95 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
              ` : `
                <button onclick="resetExercise()" class="w-full bg-[#4a90e2] text-white rounded-3xl py-6 text-2xl font-semibold shadow-lg active:scale-95 text-center">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô</button>
              `}
              <button onclick="resetExercise()" class="w-full bg-white text-[#333] border-2 border-[#e0e0e0] rounded-3xl py-6 text-2xl font-semibold shadow-lg active:scale-95 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</button>
            </div>
          </div>
        `;
      },

      fatigueRating: () => `
        <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
          <div class="flex items-center gap-4 mb-8 pt-8">
            <div class="w-12 h-12"></div>
            <h1 class="text-3xl font-semibold text-[#333]">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</h1>
          </div>

          <div class="bg-[#81c784] text-white rounded-3xl p-6 mb-8 text-center">
            ‚úÖ
            <h2 class="text-2xl font-semibold mb-2">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h2>
            <p class="text-lg opacity-90">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${appState.exerciseData?.duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
          </div>

          <div class="bg-white rounded-3xl p-6 shadow-lg mb-8">
            <h3 class="text-2xl font-semibold text-[#333] mb-4 text-center">‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢?</h3>
            <p class="text-lg text-[#666] mb-6 text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="space-y-3">
              ${[1,2,3,4,5].map(level => `
                <button onclick="selectFatigue(${level})" class="w-full bg-[#f8f9fa] hover:bg-[#e9ecef] border-2 border-[#e0e0e0] hover:border-[#4a90e2] rounded-2xl p-4 active:scale-95">
                  <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center text-white text-2xl font-bold">${level}</div>
                    <div class="text-left flex-1">
                      <p class="text-xl font-semibold text-[#333]">
                        ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${level} - ${level===1?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å (‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô)':level===2?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢':level===3?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á':level===4?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å':'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏´‡∏≠‡∏ö‡∏´‡∏≤‡∏¢‡πÉ‡∏à)'}
                      </p>
                      <p class="text-base text-[#666]">
                        ${level===1?'‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡πà‡∏≠':level===2?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏™‡∏ö‡∏≤‡∏¢':level===3?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏û‡∏≠‡∏Ñ‡∏ß‡∏£ ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢':level===4?'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏´‡∏ô‡∏±‡∏Å':'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô'}
                      </p>
                    </div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `,

      family: () => `
        <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
          <div class="bg-white p-4 shadow-sm sticky top-0 z-10">
            <div class="flex items-center gap-4">
              <button onclick="goto('home')" class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">‚¨ÖÔ∏è</button>
              <div>
                <h1 class="text-2xl font-semibold text-[#333]">‡πÅ‡∏ä‡∏ó‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</h1>
                <p class="text-base text-[#666]">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó</p>
              </div>
              <div class="ml-auto">
                <button onclick="addFriendByPhone()" class="px-3 py-2 bg-[#4a90e2] text-white rounded-xl text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
              </div>
            </div>
          </div>

          <div class="p-4 flex-1">
            <div class="space-y-2">
              ${(appState.friends || []).map(m => `
                <button onclick="openIndividualChat('${m.uid}')" class="w-full bg-white rounded-2xl p-4 shadow-sm hover:shadow-md active:scale-98 flex items-center gap-4">
                  <div class="w-16 h-16 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center text-2xl shadow-lg">üë§</div>
                  <div class="flex-1 text-left min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <h3 class="text-xl font-semibold text-[#333] truncate">${m.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</h3>
                    </div>
                    <p class="text-base text-[#666] truncate leading-relaxed">${m.phone || ''}</p>
                  </div>
                </button>
              `).join('')}
              ${(appState.friends || []).length === 0 ? `<div class="text-center text-[#666] py-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó üí¨</div>` : ''}
            </div>

            <div class="mt-6 space-y-3">
              <button onclick="openGroupChat()" class="w-full bg-[#ff9800] text-white py-4 rounded-2xl font-semibold flex items-center justify-center gap-3 shadow-lg active:scale-95">
                üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
              </button>
            </div>
          </div>
          ${renderBottomNavigation('family')}
        </div>
      `,

      individualChat: () => {
        const other = (appState.friends || []).find(f => f.uid === appState.selectedContactId);
        const cid = chatId2(auth.currentUser.uid, appState.selectedContactId);
        const msgs = appState.chats[cid] || [];
        return `
          <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
            <div class="bg-white p-4 shadow-lg sticky top-0 z-10">
              <div class="flex items-center gap-4">
                <button onclick="goto('family')" class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center active:scale-95">‚¨ÖÔ∏è</button>
                <div class="flex items-center gap-3 flex-1">
                  <div class="w-14 h-14 bg-gradient-to-br from-[#4a90e2] to-[#81c784] rounded-full flex items-center justify-center text-2xl shadow-lg">üë§</div>
                  <div>
                    <h1 class="text-xl font-semibold text-[#333]">${other?.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</h1>
                    <p class="text-base text-[#666]">${other?.phone || ''}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto" style="height: calc(100vh - 240px);">
              <div class="space-y-4 pb-4">
                ${msgs.map(m => `
                  <div class="flex ${m.from === auth.currentUser.uid ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] px-5 py-3 rounded-2xl shadow-sm ${m.from === auth.currentUser.uid ? 'bg-[#4a90e2] text-white rounded-br-sm' : 'bg-white text-[#333] rounded-bl-sm border border-gray-100'}">
                      <p class="text-lg leading-relaxed">${m.text}</p>
                      <p class="text-xs mt-2 ${m.from === auth.currentUser.uid ? 'text-blue-100' : 'text-[#999]'}">${new Date(m.createdAt).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-100">
              <div class="bg-[#f8f9fa] rounded-2xl p-3 border border-gray-200">
                <div class="flex items-center gap-3">
                  <input type="text" id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="flex-1 px-4 py-3 text-lg bg-white rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" />
                  <button onclick="sendMessageTo('${other?.uid || ''}')" class="w-14 h-14 bg-[#4a90e2] rounded-full flex items-center justify-center active:scale-95 shadow-lg">
                    ‚û§
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      groupChat: () => {
        const cid = `group_${auth.currentUser.uid}`;
        const msgs = appState.chats[cid] || [];
        return `
          <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
            <div class="bg-white p-4 shadow-lg sticky top-0 z-10">
              <div class="flex items-center gap-4">
                <button onclick="goto('family')" class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">‚¨ÖÔ∏è</button>
                <div class="flex-1">
                  <h1 class="text-2xl font-semibold text-[#333]">‡πÅ‡∏ä‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</h1>
                  <p class="text-base text-[#666]">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${appState.friends.length + 1} ‡∏Ñ‡∏ô (‡∏£‡∏ß‡∏°‡∏Ñ‡∏∏‡∏ì)</p>
                </div>
              </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto">
              <div class="space-y-4 pb-4">
                ${msgs.map(m => `
                  <div class="flex ${m.from === auth.currentUser.uid ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] px-5 py-3 rounded-2xl shadow-sm ${m.from === auth.currentUser.uid ? 'bg-[#4a90e2] text-white rounded-br-sm' : 'bg-white text-[#333] rounded-bl-sm border border-gray-100'}">
                      <p class="text-lg leading-relaxed">${m.text}</p>
                      <p class="text-xs mt-2 ${m.from === auth.currentUser.uid ? 'text-blue-100' : 'text-[#999]'}">${new Date(m.createdAt).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-100">
              <div class="bg-[#f8f9fa] rounded-2xl p-3 border border-gray-200">
                <div class="flex items-center gap-3">
                  <input type="text" id="groupMessageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="flex-1 px-4 py-3 text-lg bg-white rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" />
                  <button onclick="sendGroupMessage()" class="w-14 h-14 bg-[#4a90e2] rounded-full flex items-center justify-center active:scale-95 shadow-lg">
                    ‚û§
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      health: () => `
        <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
          <div class="flex items-center gap-4 mb-8 pt-8">
            <button onclick="goto('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
            <h1 class="text-3xl font-semibold text-[#333]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
          </div>

          ${Screens.healthMainSummary()}

          <div class="space-y-4">
            <button onclick="setHealthView('week')" class="w-full bg-[#4a90e2] text-white rounded-3xl py-6 flex items-center justify-center gap-4 shadow-lg active:scale-95">
              üìÖ <span class="text-2xl font-semibold">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</span>
            </button>
            <button onclick="setHealthView('month')" class="w-full bg-white text-[#333] border-2 border-[#e0e0e0] rounded-3xl py-6 flex items-center justify-center gap-4 shadow-lg active:scale-95">
              üìä <span class="text-2xl font-semibold">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</span>
            </button>
          </div>

          <div class="mt-6 bg-[#fff3e0] border-2 border-[#ff9800] rounded-3xl p-6">
            <p class="text-xl text-[#333] text-center">üö® ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
          </div>
        </div>
      `,

      healthMainSummary: () => {
        const today = new Date().toISOString().split('T')[0];
        const todayExercise = (appState.exerciseRecords || []).find(r => r.date === today && r.completed) || null;
        const weeklyCount = getWeeklyExerciseCount(appState.exerciseRecords);
        const currentFatigue = todayExercise?.fatigueLevel || getAverageFatigue(appState.exerciseRecords);
        return `
          ${todayExercise ? `
            <div class="bg-[#81c784] text-white rounded-3xl p-6 shadow-lg mb-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">‚úÖ</div>
                <div>
                  <h2 class="text-2xl font-semibold">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
                  <p class="text-lg opacity-90">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>
              </div>
              <div class="bg-white/10 rounded-2xl p-4">
                <div class="grid grid-cols-2 gap-4 text-center">
                  <div><p class="text-sm opacity-90">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</p><p class="text-lg font-semibold">${todayExercise.exerciseType}</p></div>
                  <div><p class="text-sm opacity-90">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</p><p class="text-lg font-semibold">${todayExercise.duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p></div>
                </div>
              </div>
            </div>
          ` : `
            <div class="bg-[#fff3e0] border-2 border-[#ffb74d] rounded-3xl p-6 shadow-lg mb-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 bg-[#ffb74d] rounded-full flex items-center justify-center">‚è∞</div>
                <div>
                  <h2 class="text-2xl font-semibold text-[#333]">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                  <p class="text-lg text-[#666]">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>
              </div>
              <button onclick="goto('exercise')" class="w-full bg-[#ffb74d] text-white rounded-2xl py-4 text-xl font-semibold shadow-lg active:scale-95 text-center">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</button>
            </div>
          `}

          <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
            <h2 class="text-2xl font-semibold text-[#333] mb-4">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
            <div class="space-y-4">
              <div class="flex items-center gap-4 p-4 bg-[#f8f9fa] rounded-2xl">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color:#ff9800">üò¥</div>
                <div class="flex-1">
                  <p class="text-lg text-[#666]">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</p>
                  <p class="text-xl font-semibold text-[#333]">${currentFatigue ? `${currentFatigue}/5` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'}</p>
                  <p class="text-sm text-[#999]">${currentFatigue ? '‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}</p>
                </div>
              </div>
              <div class="flex items-center gap-4 p-4 bg-[#f8f9fa] rounded-2xl">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color:#81c784">üèÉ‚Äç‚ôÄÔ∏è</div>
                <div class="flex-1">
                  <p class="text-lg text-[#666]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
                  <p class="text-xl font-semibold text-[#333]">${weeklyCount} ‡∏ß‡∏±‡∏ô</p>
                  <p class="text-sm text-[#999]">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 3-5 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
                </div>
              </div>
            </div>
            <div class="mt-4 p-4 bg-[#f0f8ff] rounded-2xl">
              <p class="text-lg font-semibold text-[#4a90e2] text-center">${getExerciseRecommendation(currentFatigue || 3)}</p>
            </div>
          </div>
        `;
      },

      healthWeek: async () => {
        let records = appState.exerciseRecords;
        if (appState.userMode === 'family' && appState.profile?.linkedElderlyUid) {
          const elderUid = appState.profile.linkedElderlyUid;
          const snap = await get(ref(db, pathExercise(elderUid)));
          records = snap.exists() ? Object.values(snap.val()) : [];
        }
        const daysTH = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
        const data = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const iso = d.toISOString().split('T')[0];
          const rec = (records || []).find(r => r.date === iso && r.completed);
          data.push({ day: daysTH[d.getDay()], fatigue: rec?.fatigueLevel || null, exercise: !!rec, duration: rec?.duration || null });
        }
        return `
          <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
            <div class="flex items-center gap-4 mb-8 pt-8">
              <button onclick="setHealthView('main')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
              <h1 class="text-3xl font-semibold text-[#333]">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h1>
            </div>

            <div class="space-y-4">
              ${data.map(day => `
                <div class="bg-white rounded-3xl p-6 shadow-lg">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-semibold text-[#333]">${day.day}</h3>
                    ${day.exercise ? `<div class="w-8 h-8 bg-[#81c784] rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">‚úì</span></div>` : ''}
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                      <p class="text-lg text-[#666]">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</p>
                      ${day.fatigue ? `
                        <p class="text-xl font-semibold text-[#333]">${day.fatigue}/5</p>
                        <div class="w-4 h-4 rounded-full mx-auto mt-1 ${day.fatigue <= 2 ? 'bg-[#81c784]' : day.fatigue <= 3 ? 'bg-[#ff9800]' : 'bg-[#ef5350]'}"></div>
                      ` : `
                        <p class="text-xl font-semibold text-[#999]">-</p>
                        <div class="w-4 h-4 rounded-full mx-auto mt-1 bg-[#e0e0e0]"></div>
                      `}
                    </div>
                    <div class="text-center">
                      <p class="text-lg text-[#666]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p>
                      ${day.exercise ? `<p class="text-xl font-semibold text-[#333]">‡∏≠‡∏≠‡∏Å</p><p class="text-sm text-[#666]">${day.duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p>` : `<p class="text-xl font-semibold text-[#333]">‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å</p>`}
                      <div class="w-4 h-4 rounded-full mx-auto mt-1 ${day.exercise ? 'bg-[#81c784]' : 'bg-[#e0e0e0]'}"></div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      },

      healthMonth: async () => {
        let records = appState.exerciseRecords;
        if (appState.userMode === 'family' && appState.profile?.linkedElderlyUid) {
          const elderUid = appState.profile.linkedElderlyUid;
          const snap = await get(ref(db, pathExercise(elderUid)));
          records = snap.exists() ? Object.values(snap.val()) : [];
        }
        const now = new Date();
        const weeks = [];
        for (let w = 3; w >= 0; w--) {
          const start = new Date(now); start.setDate(now.getDate() - (w * 7) - 6);
          const end = new Date(now); end.setDate(now.getDate() - (w * 7));
          const weekRecords = (records || []).filter(r => {
            const d = new Date(r.date);
            return d >= start && d <= end && r.completed;
          });
          const avg = weekRecords.length ? (weekRecords.reduce((s, r) => s + (r.fatigueLevel || 0), 0) / weekRecords.length) : 0;
          weeks.push({ week: `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${4 - w}`, avgFatigue: avg ? Math.round(avg * 10) / 10 : 0, exerciseDays: weekRecords.length });
        }
        const today = new Date().toISOString().split('T')[0];
        const todayRec = (records || []).find(r => r.date === today && r.completed);
        const currentFatigue = todayRec?.fatigueLevel || getAverageFatigue(records);

        return `
          <div class="min-h-screen bg-[#f0f8ff] p-6 flex flex-col">
            <div class="flex items-center gap-4 mb-8 pt-8">
              <button onclick="setHealthView('main')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
              <h1 class="text-3xl font-semibold text-[#333]">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h1>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
              <h2 class="text-2xl font-semibold text-[#333] mb-4 text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° 30 ‡∏ß‡∏±‡∏ô</h2>
              <div class="grid grid-cols-1 gap-4">
                <div class="text-center p-4 bg-[#fff3e0] rounded-2xl">
                  <p class="text-lg text-[#666]">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                  ${currentFatigue ? `<p class="text-3xl font-semibold text-[#ff9800]">${currentFatigue}/5</p>` : `<p class="text-xl font-semibold text-[#999]">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`}
                </div>
                <div class="text-center p-4 bg-[#e8f5e8] rounded-2xl">
                  <p class="text-lg text-[#666]">‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p>
                  <p class="text-3xl font-semibold text-[#81c784]">${weeks.reduce((s, w) => s + w.exerciseDays, 0)} ‡∏ß‡∏±‡∏ô</p>
                </div>
              </div>
              <div class="mt-4 p-4 bg-[#f0f8ff] rounded-2xl">
                <p class="text-lg font-semibold text-[#4a90e2] text-center">${getExerciseRecommendation(currentFatigue || 3)}</p>
              </div>
            </div>

            <div class="space-y-4">
              <h3 class="text-2xl font-semibold text-[#333]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
              ${weeks.map(week => `
                <div class="bg-white rounded-3xl p-6 shadow-lg">
                  <h4 class="text-xl font-semibold text-[#333] mb-4">${week.week}</h4>
                  <div class="grid grid-cols-1 gap-3">
                    <div class="flex items-center justify-between p-3 bg-[#f8f9fa] rounded-xl">
                      <span class="text-lg text-[#666]">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>
                      <span class="text-lg font-semibold text-[#333]">${week.avgFatigue.toFixed(1)}/5</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-[#f8f9fa] rounded-xl">
                      <span class="text-lg text-[#666]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</span>
                      <span class="text-lg font-semibold text-[#81c784]">${week.exerciseDays} ‡∏ß‡∏±‡∏ô</span>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      },

      healthHistory: () => {
        const exerciseDays = (appState.exerciseRecords || []).filter(r => r.completed).length;
        const weeklyDays = getWeeklyExerciseCount(appState.exerciseRecords);
        const avgFatigue = getAverageFatigue(appState.exerciseRecords);
        const thisMonth = new Date();
        const totalMinutes = (appState.exerciseRecords || [])
          .filter(r => {
            const d = new Date(r.date);
            return r.completed && d.getMonth() === thisMonth.getMonth() && d.getFullYear() === thisMonth.getFullYear();
          })
          .reduce((s, r) => s + (r.duration || 0), 0);

        return `
          <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
            <div class="flex-1 p-6 pb-32">
              <div class="flex items-center gap-4 mb-8 pt-8">
                <button onclick="goto('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
                <h1 class="text-3xl font-semibold text-[#333]">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
              </div>

              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-[#81c784] text-white rounded-2xl p-4">
                  <div class="flex items-center gap-2 mb-2">üèÉ<span class="text-sm font-medium">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</span></div>
                  <p class="text-2xl font-bold">${weeklyDays}/7</p>
                  <p class="text-sm opacity-90">‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
                  <p class="text-xs opacity-75 mt-1">‡∏£‡∏ß‡∏° ${exerciseDays} ‡∏ß‡∏±‡∏ô</p>
                </div>
                <div class="bg-[#ff9800] text-white rounded-2xl p-4">
                  <div class="flex items-center gap-2 mb-2">‚ö°<span class="text-sm font-medium">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span></div>
                  ${avgFatigue ? `
                    <p class="text-2xl font-bold">${avgFatigue}/5</p><p class="text-sm opacity-90">‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p>
                  ` : `
                    <p class="text-lg font-bold">-</p><p class="text-sm opacity-90">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                  `}
                </div>
                <div class="bg-[#4a90e2] text-white rounded-2xl p-4">
                  <div class="flex items-center gap-2 mb-2">üìÖ<span class="text-sm font-medium">‡∏ô‡∏≤‡∏ó‡∏µ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</span></div>
                  <p class="text-2xl font-bold">${totalMinutes}</p>
                  <p class="text-sm opacity-90">‡∏ô‡∏≤‡∏ó‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
                <div class="bg-[#9c27b0] text-white rounded-2xl p-4">
                  <div class="flex items-center gap-2 mb-2">üìà<span class="text-sm font-medium">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</span></div>
                  <p class="text-2xl font-bold">
                    ${weeklyDays >= 5 ? '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°' : weeklyDays >= 3 ? '‡∏î‡∏µ' : weeklyDays >= 1 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}
                  </p>
                  <p class="text-sm opacity-90">‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p>
                </div>
              </div>

              <div class="space-y-4">
                <h3 class="text-xl font-semibold text-[#333]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                ${(appState.exerciseRecords || []).map(r => `
                  <div class="bg-white rounded-2xl p-5 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                      <h4 class="text-lg font-semibold text-[#333]">${formatThaiDate(r.date)}</h4>
                      <div class="flex gap-2">
                        ${r.completed ? `<div class="w-6 h-6 bg-[#81c784] rounded-full flex items-center justify-center"><span class="text-white text-xs">‚úì</span></div>` : ''}
                        ${r.fatigueLevel ? `<div class="w-6 h-6 bg-[#ff9800] rounded-full flex items-center justify-center"><span class="text-white text-xs">‚ö°</span></div>` : ''}
                      </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                      ${r.completed ? `
                        <div class="bg-[#e8f5e8] rounded-xl p-4">
                          <div class="flex items-center gap-2 mb-2"><span class="text-[#81c784]">‚úì</span><p class="text-sm font-medium text-[#81c784]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p></div>
                          <p class="text-base font-medium text-[#333] mb-2">${r.exerciseType} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${r.duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                          ${r.fatigueLevel ? `
                            <div class="flex items-center gap-2">
                              <span class="text-sm text-[#666]">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢:</span>
                              <span class="text-sm font-medium text-[#333]">${r.fatigueLevel}/5</span>
                              <span class="text-xs px-2 py-1 rounded-full ${
                                r.fatigueLevel <= 2 ? 'bg-[#81c784] text-white' : r.fatigueLevel <= 3 ? 'bg-[#ff9800] text-white' : 'bg-[#ef5350] text-white'
                              }">
                                ${r.fatigueLevel <= 2 ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : r.fatigueLevel <= 3 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å'}
                              </span>
                            </div>
                          ` : ''}
                        </div>
                      ` : `
                        <div class="bg-[#f5f5f5] rounded-xl p-4">
                          <div class="flex items-center gap-2"><div class="w-4 h-4 bg-[#999] rounded-full"></div><p class="text-base font-medium text-[#999]">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p></div>
                        </div>
                      `}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      },

      settings: () => {
        const isElderly = appState.userMode === 'elderly';
        return `
          <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
            <div class="flex-1 p-6 pb-32">
              <div class="flex items-center gap-4 mb-6 pt-8">
                <button onclick="goto('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
                <div><h1 class="text-3xl font-semibold text-[#333]">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1><p class="text-lg text-[#666]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>
              </div>

              <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-[#333] mb-4">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 ${isElderly ? 'bg-[#81c784]' : 'bg-[#ff9800]'} rounded-full flex items-center justify-center">
                      <span class="text-2xl">${isElderly ? 'üë¥' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'}</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-semibold text-[#333]">${appState.profile?.name || ''}</h3>
                      <p class="text-lg text-[#666]">${appState.profile?.phone || ''}</p>
                    </div>
                  </div>
                  <button onclick="goto('userSelection')" class="bg-[#4a90e2] text-white rounded-xl py-2 px-4 text-lg font-semibold active:scale-95">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î</button>
                </div>
              </div>

              <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-[#333] mb-4">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
                <div class="space-y-4">
                  ${isElderly ? `
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">üèÉ</span>
                        <div>
                          <p class="text-lg font-semibold text-[#333]">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p>
                          <p class="text-sm text-[#666]">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>
                        </div>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" ${appState.notificationSettings.elderlyExerciseReminder ? 'checked' : ''} onchange="toggleElderlyExerciseReminder(this.checked)" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                      </label>
                    </div>
                  ` : `
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                          <p class="text-lg font-semibold text-[#333]">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                          <p class="text-sm text-[#666]">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</p>
                        </div>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" ${appState.notificationSettings.familyNotifyOnElderlyDone ? 'checked' : ''} onchange="toggleFamilyNotifyOnDone(this.checked)" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                      </label>
                    </div>
                  `}
                </div>
              </div>

              <div class="space-y-4">
                <button onclick="goto('help')" class="w-full bg-white rounded-2xl p-6 shadow-lg border-2 border-[#e0e0e0] active:scale-95">
                  <div class="flex items-center gap-4"><span class="text-3xl">‚ùì</span><div class="text-left"><h3 class="text-xl font-semibold text-[#333]">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3><p class="text-lg text-[#666]">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p></div></div>
                </button>
                <button onclick="doLogout()" class="w-full bg-[#ef5350] text-white rounded-2xl p-4 text-lg font-semibold shadow-lg active:scale-95">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
              </div>
            </div>
            ${renderBottomNavigation('settings')}
          </div>
        `;
      },

      help: () => {
        const isElderly = appState.userMode === 'elderly';
        return `
          <div class="min-h-screen bg-[#f0f8ff] flex flex-col">
            <div class="flex-1 p-6 pb-32">
              <div class="flex items-center gap-4 mb-8 pt-8">
                <button onclick="goto('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">‚¨ÖÔ∏è</button>
                <h1 class="${isElderly ? 'text-4xl' : 'text-3xl'} font-semibold text-[#333]">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h1>
              </div>

              <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
                <div class="text-center">
                  <div class="w-16 h-16 bg-[#4a90e2] rounded-full flex items-center justify-center mx-auto mb-4">ü§ù</div>
                  <h2 class="${isElderly ? 'text-3xl' : 'text-2xl'} font-semibold text-[#333] mb-3">${isElderly ? '‡πÄ‡∏£‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì' : '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'}</h2>
                  <p class="${isElderly ? 'text-xl' : 'text-lg'} text-[#666] leading-relaxed">${isElderly ? '‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏'}</p>
                </div>
              </div>

              <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
                <h3 class="text-2xl font-semibold text-[#333] mb-4">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <div class="space-y-3">
                  <div class="p-4 bg-[#f8f9fa] rounded-2xl"><p class="font-semibold text-[#333] mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p><p class="text-[#666]">1) ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞ OTP 2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î 3) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå</p></div>
                  <div class="p-4 bg-[#f8f9fa] rounded-2xl"><p class="font-semibold text-[#333] mb-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p><p class="text-[#666]">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p></div>
                  <div class="p-4 bg-[#f8f9fa] rounded-2xl"><p class="font-semibold text-[#333] mb-1">‡πÅ‡∏ä‡∏ó‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p><p class="text-[#666]">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p></div>
                  <div class="p-4 bg-[#f8f9fa] rounded-2xl"><p class="font-semibold text-[#333] mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p><p class="text-[#666]">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏: ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p></div>
                </div>

                <h3 class="text-xl font-semibold text-[#333] mt-6 mb-3">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</h3>
                <div class="space-y-3">
                  <details class="bg-[#f8f9fa] rounded-2xl p-4"><summary class="font-semibold text-[#333] cursor-pointer">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö OTP</summary><p class="text-[#666] mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ</p></details>
                  <details class="bg-[#f8f9fa] rounded-2xl p-4"><summary class="font-semibold text-[#333] cursor-pointer">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</summary><p class="text-[#666] mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (+66)</p></details>
                  <details class="bg-[#f8f9fa] rounded-2xl p-4"><summary class="font-semibold text-[#333] cursor-pointer">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô</summary><p class="text-[#666] mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</p></details>
                </div>
              </div>

              <div class="bg-white rounded-3xl p-6 shadow-lg">
                <h3 class="text-2xl font-semibold text-[#333] mb-4">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</h3>
                <div id="supportChat" class="space-y-3 max-h-72 overflow-y-auto mb-3 p-3 bg-[#f8f9fa] rounded-2xl border border-gray-200">
                  <div class="flex justify-start"><div class="max-w-[80%] px-4 py-2 rounded-2xl bg-white border border-gray-100"><p class="text-sm text-[#333]">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡πà‡∏∞ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p></div></div>
                </div>
                <div class="flex items-center gap-2">
                  <input id="supportInput" type="text" class="flex-1 px-4 py-3 text-base bg-[#f8f9fa] rounded-xl border border-gray-200 focus:border-[#4a90e2] outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
                  <button onclick="sendSupportMessage()" class="px-4 py-3 bg-[#4a90e2] text-white rounded-xl">‡∏™‡πà‡∏á</button>
                </div>
              </div>
            </div>
            ${renderBottomNavigation('help')}
          </div>
        `;
      }
    };

    function renderBottomNavigation(current) {
      const isElderly = appState.userMode === 'elderly';
      const buttonSize = isElderly ? 'w-16 h-16' : 'w-12 h-12';
      const textSize = isElderly ? 'text-xl' : 'text-base';
      const padding = isElderly ? 'p-6' : 'p-4';
      return `
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-[#e0e0e0] shadow-lg z-50 ${padding}">
          <div class="max-w-md mx-auto flex justify-around">
            <button onclick="goto('home')" class="flex flex-col items-center gap-2">
              <div class="${buttonSize} rounded-full flex items-center justify-center ${current==='home' ? 'bg-[#4a90e2] text-white' : 'bg-[#f0f0f0] text-[#666]'}">üè†</div>
              <span class="${textSize} font-semibold ${current==='home' ? 'text-[#4a90e2]' : 'text-[#666]'}">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </button>
            <button onclick="goto('settings')" class="flex flex-col items-center gap-2">
              <div class="${buttonSize} rounded-full flex items-center justify-center ${current==='settings' ? 'bg-[#4a90e2] text-white' : 'bg-[#f0f0f0] text-[#666]'}">‚öôÔ∏è</div>
              <span class="${textSize} font-semibold ${current==='settings' ? 'text-[#4a90e2]' : 'text-[#666]'}">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </button>
            <button onclick="goto('help')" class="flex flex-col items-center gap-2">
              <div class="${buttonSize} rounded-full flex items-center justify-center ${current==='help' ? 'bg-[#4a90e2] text-white' : 'bg-[#f0f0f0] text-[#666]'}">‚ùì</div>
              <span class="${textSize} font-semibold ${current==='help' ? 'text-[#4a90e2]' : 'text-[#666]'}">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
            </button>
          </div>
        </div>
      `;
    }

    function renderNotificationModal() {
      if (!appState.showNotification) return '';
      const isElderly = appState.userMode === 'elderly';
      let title = '‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢';
      let message = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?';
      let subtitle = '‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ö‡∏ô‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ';
      let startText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢';
      let laterText = '‡∏õ‡∏¥‡∏î';

      if (appState.notificationType === 'elderDone') {
        title = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
        message = '‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
        subtitle = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
        startText = '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
      }

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 sm:p-6 z-50">
          <div class="bg-white rounded-3xl p-6 sm:p-8 max-w-sm sm:max-w-md w-full mx-4 shadow-2xl animate-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4 sm:mb-6">
              <div class="w-12 h-12 sm:w-16 sm:h-16 bg-[#81c784] rounded-full flex items-center justify-center">‚è±Ô∏è</div>
              <button onclick="closeNotification()" class="min-touch-target w-8 h-8 bg-[#e0e0e0] rounded-full flex items-center justify-center">‚úï</button>
            </div>
            <div class="text-center mb-6 sm:mb-8">
              <h2 class="font-semibold text-[#333] mb-3 sm:mb-4 leading-tight ${isElderly ? 'text-2xl sm:text-3xl' : 'text-xl sm:text-2xl'}">${title}</h2>
              <p class="text-[#666] leading-relaxed ${isElderly ? 'text-lg sm:text-xl' : 'text-base sm:text-lg'}">${message}</p>
            </div>
            <div class="text-center mb-6 sm:mb-8">
              <p class="text-[#666] leading-snug ${isElderly ? 'text-base sm:text-lg' : 'text-sm sm:text-base'}">${subtitle}</p>
            </div>
            <div class="space-y-3 sm:space-y-4">
              <button onclick="${appState.notificationType==='exercise' ? 'startNotification()' : 'closeNotification()'}" class="w-full bg-[#81c784] text-white rounded-3xl font-semibold shadow-lg min-touch-target text-center ${isElderly ? 'py-5 sm:py-6 text-xl sm:text-2xl' : 'py-4 text-lg'}">${startText}</button>
              <button onclick="closeNotification()" class="w-full bg-white text-[#333] border-2 border-[#e0e0e0] rounded-3xl font-semibold shadow-lg min-touch-target text-center ${isElderly ? 'py-5 sm:py-6 text-xl sm:text-2xl' : 'py-4 text-lg'}">${laterText}</button>
            </div>
            <div class="mt-4 sm:mt-6 text-center">
              <p class="text-[#666] ${isElderly ? 'text-base sm:text-lg' : 'text-sm sm:text-base'}">${isElderly ? 'üí™ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô!' : '‚ù§Ô∏è ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô'}</p>
            </div>
          </div>
        </div>
      `;
    }

    // Support auto-reply
    function sendSupportMessage() {
      const input = document.getElementById('supportInput');
      const text = input?.value?.trim();
      if (!text) return;
      const box = document.getElementById('supportChat');
      const me = document.createElement('div');
      me.className = 'flex justify-end';
      me.innerHTML = `<div class="max-w-[80%] px-4 py-2 rounded-2xl bg-[#4a90e2] text-white rounded-br-sm"><p class="text-sm">${text}</p></div>`;
      box.appendChild(me);
      input.value = '';
      box.scrollTop = box.scrollHeight;

      setTimeout(() => {
        const bot = document.createElement('div');
        bot.className = 'flex justify-start';
        bot.innerHTML = `<div class="max-w-[80%] px-4 py-2 rounded-2xl bg-white border border-gray-100"><p class="text-sm text-[#333]">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞</p></div>`;
        box.appendChild(bot);
        box.scrollTop = box.scrollHeight;
      }, 600);
    }

    // Async render helper
    async function renderAsync(builder) {
      const container = document.getElementById('screen-container');
      container.innerHTML = await builder();
      if (appState.showNotification) container.innerHTML += renderNotificationModal();
    }

    function render() {
      const container = document.getElementById('screen-container');
      let html = '';
      switch (appState.screen) {
        case 'login': html = Screens.login(); break;
        case 'verifyOtp': html = Screens.verifyOtp(); break;
        case 'userSelection': html = Screens.userSelection(); break;
        case 'home': html = Screens.home(); break;
        case 'exercise': html = Screens.exercise(); break;
        case 'exerciseSession': html = Screens.exerciseSession(); break;
        case 'fatigueRating': html = Screens.fatigueRating(); break;
        case 'family': html = Screens.family(); break;
        case 'individualChat': html = Screens.individualChat(); break;
        case 'groupChat': html = Screens.groupChat(); break;
        case 'health': html = Screens.health(); break;
        case 'healthHistory': html = Screens.healthHistory(); break;
        case 'settings': html = Screens.settings(); break;
        case 'help': html = Screens.help(); break;
        default: html = Screens.home();
      }
      container.innerHTML = html;
      if (appState.showNotification) container.innerHTML += renderNotificationModal();
    }

    // Expose to window
    window.requestOTP = requestOTP;
    window.verifyOTP = verifyOTP;
    window.goto = goto;
    window.setMode = setMode;
    window.setHealthView = setHealthView;
    window.startExercise = startExercise;
    window.toggleExercise = toggleExercise;
    window.stopEarly = stopEarly;
    window.resetExercise = resetExercise;
    window.selectFatigue = selectFatigue;
    window.openIndividualChat = openIndividualChat;
    window.sendMessageTo = sendMessageTo;
    window.openGroupChat = openGroupChat;
    window.sendGroupMessage = sendGroupMessage;
    window.addFriendByPhone = addFriendByPhone;
    window.toggleElderlyExerciseReminder = toggleElderlyExerciseReminder;
    window.toggleFamilyNotifyOnDone = toggleFamilyNotifyOnDone;
    window.sendSupportMessage = sendSupportMessage;
    window.doLogout = doLogout;
    window.startNotification = startNotification;
    window.closeNotification = closeNotification;
  </script>
</body>
</html>
